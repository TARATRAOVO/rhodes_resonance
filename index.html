<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <title>Rhodes Resonance 控制台</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/qdYtZ8AAAAASUVORK5CYII=">
    <!-- Fonts: Inter Tight (Latin) + Noto Sans SC (CJK) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;600;700&family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand" title="Rhodes Resonance 控制台">Rhodes Resonance</div>
        <div class="controls">
          <button id="btnStart" class="btn">开始行动</button>
          <button id="btnRestart" class="btn secondary">重启战局</button>
          <button id="btnStop" class="btn danger" disabled>终止</button>
          <span id="status" class="status-badge dim">待命</span>
          <label for="storyPicker" class="dim ml-8">战局</label>
          <select id="storyPicker"></select>
        </div>
        <div class="topbar-actions">
          <button id="btnToggleSide" class="btn ghost" aria-label="切换侧栏">侧栏</button>
          <button id="btnSettings" class="btn ghost" aria-label="设置">设置</button>
        </div>
      </div>
    </header>
    <div class="wrap">
      <div class="col">
        <div class="panel" id="story">
          <h3 class="h">战术日志</h3>
          <div id="storyLines"></div>
          <div id="cmdBar" class="cmd-bar">
            <div class="row cli-row">
              <span class="prompt" id="cmdPrompt">&gt;</span>
              <input id="txtPlayer" type="text" placeholder="输入指令/对白…（轮到你时可发送）" />
              <button id="btnSend" disabled>发送</button>
            </div>
            <div id="playerHint" class="dim"></div>
          </div>
        </div>
      </div>
      <div class="col side">
        <div class="panel" id="statusPanel">
          <h3 class="h">作战态势</h3>
          <div class="kv" id="hud"></div>
        </div>
        <div id="sideSpacer" aria-hidden="true"></div>
        <div class="panel" id="mapPanel">
          <h3 class="h">战场地图</h3>
          <div id="mapWrap"><canvas id="mapCanvas"></canvas></div>
          <div id="mapHint" class="dim"></div>
        </div>
        
      </div>
    </div>
    <!-- Settings Drawer -->
    <div id="settingsDrawer" class="drawer hidden" aria-hidden="true">
      <div class="drawer-head">
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="story" role="tab" aria-selected="true">剧本</button>
          <button class="tab" data-tab="weapons" role="tab" aria-selected="false">武装</button>
          <button class="tab" data-tab="arts" role="tab" aria-selected="false">术式</button>
          <button class="tab" data-tab="timeline" role="tab" aria-selected="false">时间轴</button>
          <button class="tab" data-tab="characters" role="tab" aria-selected="false">单位</button>
        </div>
        <div class="ops">
          <button id="btnCfgReset" class="ghost">重置</button>
          <button id="btnCfgSave">保存</button>
          <button id="btnCfgSaveRestart">保存并重启</button>
          <button id="btnCfgClose" class="ghost">关闭</button>
        </div>
      </div>
      <div class="drawer-body">
        <!-- Story Tab -->
        <div class="tabpane" data-pane="story">
          <div class="toolbar-row">
            <label class="lbl m-0">当前故事</label>
            <select id="stStorySelect"></select>
            <button id="btnStoryNew" class="sm">新建</button>
            <button id="btnStoryCopy" class="sm">复制</button>
            <button id="btnStoryRename" class="sm">重命名</button>
            <button id="btnStoryDelete" class="sm danger">删除</button>
          </div>

          <div class="section">
            <h4 class="h">基本信息</h4>
            <div class="grid2">
              <div>
                <label class="lbl">场景名</label>
                <input id="stSceneName" type="text" />
              </div>
              <div>
                <label class="lbl">时间</label>
                <input id="stSceneTime" type="text" placeholder="08:00" />
              </div>
              <div>
                <label class="lbl">天气</label>
                <input id="stSceneWeather" list="weatherList" type="text" placeholder="overcast" />
                <datalist id="weatherList">
                  <option value="sunny"></option>
                  <option value="overcast"></option>
                  <option value="rain"></option>
                  <option value="storm"></option>
                  <option value="snow"></option>
                </datalist>
              </div>
            </div>
            <label class="lbl">场景描述（环境/氛围/限制）</label>
            <textarea id="stSceneDesc" rows="3"></textarea>
          </div>

          <div class="section">
            <h4 class="h">细节与目标</h4>
            <div class="grid2">
              <div>
                <label class="lbl">关键细节</label>
                <div id="stDetails" class="list-edit"></div>
                <button id="btnAddDetail" class="sm">+ 添加细节</button>
              </div>
              <div>
                <label class="lbl">作战目标</label>
                <div id="stObjectives" class="list-edit"></div>
                <button id="btnAddObjective" class="sm">+ 添加目标</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h4 class="h">初始布置</h4>
            <div class="tbl-wrap">
              <table class="tbl" id="stPositions">
                <thead><tr><th>名称</th><th>X</th><th>Y</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="toolbar-row">
              <select id="stPosNameSel"></select>
              <input id="stPosX" type="number" placeholder="X" />
              <input id="stPosY" type="number" placeholder="Y" />
              <button id="btnAddPos" class="sm">+ 添加坐标</button>
            </div>
          </div>

          <div class="section">
            <h4 class="h">结局（endings）</h4>
            <div class="tbl-wrap">
              <table class="tbl auto">
                <thead>
                  <tr>
                    <th style="width:14ch">ID</th>
                    <th style="width:16ch">标题</th>
                    <th style="width:14ch">结果</th>
                    <th style="width:10ch">优先级</th>
                    <th>条件（when，JSON）</th>
                    <th style="width:10ch">操作</th>
                  </tr>
                </thead>
                <tbody id="stEndingsBody"></tbody>
              </table>
            </div>
            <div class="toolbar-row">
              <button id="btnAddEnding" class="sm">新增结局</button>
            </div>
            <div class="dim" style="margin-top:6px">提示：条件支持 any/all/not 与叶子条件（objectives/time/actors_alive/dead/participants_alive_*/hostiles_present/marks_contains/tension_*/location_is）。暂以 JSON 填写。</div>
          </div>

          <div class="section">
            <h4 class="h">多场景与入口</h4>
            <div class="grid2">
              <div>
                <label class="lbl">场景（scenes）</label>
                <div class="tbl-wrap">
                  <table class="tbl" id="stScenesTable">
                    <thead><tr><th>场景ID</th><th>名称</th><th>细节数</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="toolbar-row">
                  <button id="btnAddScene" class="sm">+ 新增场景</button>
                </div>
                <div id="stSceneEditor" class="mt-6 hidden">
                  <div class="grid2">
                    <div>
                      <label class="lbl">编辑场景ID</label>
                      <input id="stSceneEditId" type="text" disabled />
                    </div>
                    <div>
                      <label class="lbl">名称</label>
                      <input id="stSceneEditName" type="text" />
                    </div>
                  </div>
                  <label class="lbl">关键细节</label>
                  <div id="stSceneEditDetails" class="list-edit"></div>
                  <button id="btnAddSceneDetail" class="sm">+ 添加细节</button>
                </div>
              </div>
              <div>
                <label class="lbl">入口（entrances）</label>
                <div class="tbl-wrap">
                  <table class="tbl" id="stEntrTable">
                    <thead><tr><th>ID</th><th>标签</th><th>from</th><th>to</th><th>atX</th><th>atY</th><th>spawnX</th><th>spawnY</th><th>描述</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="toolbar-row">
                  <button id="btnAddEntrance" class="sm">+ 新增入口</button>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <h4 class="h">初始场景与分场坐标</h4>
            <div class="grid2">
              <div>
                <label class="lbl">初始场景（initial_scenes）</label>
                <div class="tbl-wrap">
                  <table class="tbl" id="stInitScenesTable">
                    <thead><tr><th>角色</th><th>场景ID</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="toolbar-row">
                  <select id="stInitSceneNameSel"></select>
                  <input id="stInitSceneId" type="text" placeholder="scene_id" />
                  <button id="btnSetInitScene" class="sm">设置初始场景</button>
                </div>
              </div>
              <div>
                <label class="lbl">场景内坐标（scene_positions）</label>
                <div class="toolbar-row">
                  <select id="stScenePosSel"></select>
                </div>
                <div class="tbl-wrap">
                  <table class="tbl" id="stScenePosTable">
                    <thead><tr><th>角色</th><th>X</th><th>Y</th><th></th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
                <div class="toolbar-row">
                  <select id="stScenePosNameSel"></select>
                  <input id="stScenePosX" type="number" placeholder="X" />
                  <input id="stScenePosY" type="number" placeholder="Y" />
                  <button id="btnAddScenePos" class="sm">添加/更新</button>
                </div>
              </div>
            </div>
          </div>
        </div><div class="tabpane hidden" data-pane="weapons">
          <table class="tbl" id="wpTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>名称</th>
                <th>射程(步)</th>
                <th>相关属性</th>
                <th>伤害公式（不含属性加成）</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="btnAddWeapon" class="sm">+ 添加武装</button>
        </div>

        <!-- Arts Tab -->
        <div class="tabpane hidden" data-pane="arts">
          <table class="tbl" id="artsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>名称</th>
                <th>施术检定</th>
                <th>抗性</th>
                <th>射程(步)</th>
                <th>伤害</th>
                <th>控制效果</th>
                <th>持续</th>
                <th>MP</th>
                <th>标签</th>
                <th>描述</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="btnAddArt" class="sm">+ 新增术式</button>
        </div>

        <!-- Timeline Tab -->
        <div class="tabpane hidden" data-pane="timeline">
          <table class="tbl" id="tlTable">
            <thead>
              <tr>
                <th>事件名</th>
                <th>时间(HH:MM)</th>
                <th>备注</th>
                <th>效果（effects，JSON）</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="btnAddEvent" class="sm">+ 新增事件</button>
          <div class="dim" style="margin-top:6px">提示：时间轴保存在 story.json 的 stories.<ID>.events；运行时需要推进时间（advance_time）才会触发。</div>
        </div>
        
        <!-- When Builder Modal -->
        <div id="whenModal" class="modal hidden" aria-hidden="true">
          <div class="modal-backdrop"></div>
          <div class="modal-inner">
            <div class="modal-head">
              <h4 class="h">编辑结局条件</h4>
              <div class="ops">
                <button id="btnWhenCancel" class="ghost">取消</button>
                <button id="btnWhenOk">确定</button>
              </div>
            </div>
            <div class="modal-body">
              <div id="whenTree"></div>
              <div class="dim" style="margin-top:6px">说明：支持任意嵌套的 any/all/not；叶子条件包括 objectives/time/actors_alive/actors_dead/participants_alive_*/hostiles_present/marks_contains/tension_*/location_is。</div>
            </div>
          </div>
        </div>

        <!-- Characters Tab (表单化) -->
        <div class="tabpane hidden" data-pane="characters">
          <div class="grid2">
            <div>
              <label class="lbl">单位列表</label>
              <div id="chList" class="vlist"></div>
              <div class="toolbar-row mt-6">
                <button id="btnAddChar" class="sm">+ 新增单位</button>
                <button id="btnDelChar" class="sm">删除</button>
              </div>
            </div>
            <div>
              <label class="lbl">单位档案</label>
              <div class="grid2">
                <div>
                  <label class="lbl">名称</label>
                  <input id="chName" type="text" disabled />
                </div>
                <div>
                  <label class="lbl">类型</label>
                  <select id="chType">
                    <option value="npc">npc</option>
                    <option value="player">player</option>
                  </select>
                </div>
              </div>
              <label class="lbl">性格设定</label>
              <textarea id="chPersona" rows="3"></textarea>
              <label class="lbl">外观</label>
              <textarea id="chAppearance" rows="3"></textarea>

              <label class="lbl">口癖/台词</label>
              <div id="chQuotes" class="list-edit"></div>
              <button id="btnAddQuote" class="sm">+ 添加台词</button>

              <label class="lbl">单位属性</label>
              <div class="grid2">
                <div><label class="lbl">AC</label><input id="chAC" type="number" /></div>
              </div>
              <div class="grid2">
                <div><label class="lbl">最大HP</label><input id="chMaxHP" type="number" /></div>
                <div>
                  <label class="lbl">移动(步/回合)</label>
                  <div class="dim">自动计算（由数值推导，无法手动设置）</div>
                </div>
              </div>
              <div class="grid2">
                <div><label class="lbl">STR</label><input id="chSTR" type="number" /></div>
                <div><label class="lbl">DEX</label><input id="chDEX" type="number" /></div>
                <div><label class="lbl">CON</label><input id="chCON" type="number" /></div>
                <div><label class="lbl">INT</label><input id="chINT" type="number" /></div>
              </div>
              <!-- 技能/豁免熟练度设置已移除 -->

              <label class="lbl">携行物</label>
              <table class="tbl" id="chInvTable">
                <thead><tr><th>物品ID</th><th>数量</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
              <div>
                <select id="chInvIdSel"></select>
                <input id="chInvCount" type="number" placeholder="数量" />
                <button id="btnAddInv" class="sm">+ 添加物品</button>
              </div>

            
            </div>
          </div>
        </div>
      </div>
      <div id="cfgHint" class="dim">保存后需重启生效。</div>
    </div>
    <!-- Optional runtime config: allows pointing the frontend to a remote backend origin -->
    <script src="config.js"></script>
    <script src="app.js"></script>
  </body>
</html>
